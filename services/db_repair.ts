/**
 * SCRIPT DE REPARO E CONFIGURAÇÃO DO BANCO DE DADOS
 * ---------------------------------------------------
 * O erro de "item não aparecendo" ou falha ao salvar geralmente ocorre porque
 * as colunas no banco de dados não existem ou têm nomes diferentes do que o código espera.
 * 
 * Instruções:
 * 1. Copie o código SQL abaixo (entre as crases).
 * 2. Vá ao Painel do Supabase -> SQL Editor.
 * 3. Cole e execute (RUN).
 * 
 * O que este script faz:
 * 1. Garante que as tabelas existam com as colunas EXATAS (em snake_case) que o código usa.
 * 2. Aplica as permissões (RLS) permissivas para que o app funcione.
 * 3. Garante que a coluna ID seja 'GENERATED BY DEFAULT' para permitir flexibilidade (embora o código agora deixe o banco gerir).
 */

export const REPAIR_DB_SQL = `
-- 1. CRIAÇÃO DAS TABELAS (Se não existirem)

CREATE TABLE IF NOT EXISTS public.items (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    description text,
    detailed_description text,
    location_found text,
    location_stored text,
    date_found text,
    date_registered text,
    status text,
    returned_to text,
    returned_date text,
    history jsonb DEFAULT '[]'::jsonb
);

CREATE TABLE IF NOT EXISTS public.reports (
    id text PRIMARY KEY,
    item_description text,
    person_id text,
    person_name text,
    whatsapp text,
    email text,
    status text,
    created_at text,
    history jsonb DEFAULT '[]'::jsonb
);

CREATE TABLE IF NOT EXISTS public.people (
    id text PRIMARY KEY,
    matricula text,
    name text,
    type text
);

CREATE TABLE IF NOT EXISTS public.users (
    id text PRIMARY KEY,
    matricula text,
    name text,
    password text,
    level text,
    logs text[]
);

CREATE TABLE IF NOT EXISTS public.config (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    sector text,
    campus text
);

-- CORREÇÃO PARA ERRO "insert a non-DEFAULT value into column id"
-- Caso a tabela já exista como GENERATED ALWAYS, isso corrige para BY DEFAULT.
ALTER TABLE public.items ALTER COLUMN id SET GENERATED BY DEFAULT;

-- 2. HABILITAR RLS (Segurança)
ALTER TABLE public.items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.people ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.config ENABLE ROW LEVEL SECURITY;

-- 3. DEFINIR POLÍTICAS DE ACESSO (Modo Permissivo para o App atual)

-- Limpar antigas para evitar erros
DROP POLICY IF EXISTS "Permissivo Items" ON public.items;
DROP POLICY IF EXISTS "Permissivo Reports" ON public.reports;
DROP POLICY IF EXISTS "Permissivo People" ON public.people;
DROP POLICY IF EXISTS "Permissivo Users" ON public.users;
DROP POLICY IF EXISTS "Permissivo Config" ON public.config;

-- Criar novas políticas
CREATE POLICY "Permissivo Items" ON public.items FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Permissivo Reports" ON public.reports FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Permissivo People" ON public.people FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Permissivo Users" ON public.users FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Permissivo Config" ON public.config FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
`;
