
/**
 * SCRIPT DE REPARO E CONFIGURAÇÃO DO BANCO DE DADOS
 * ---------------------------------------------------
 * Instruções:
 * 1. Copie o código SQL abaixo.
 * 2. Vá ao Painel do Supabase -> SQL Editor.
 * 3. Cole e execute (RUN).
 * 
 * Este script garante que o banco tenha as colunas necessárias para:
 * - Vinculação de itens a relatos (Histórico JSONB).
 * - Devolução de itens (Colunas returned_to e returned_date).
 * - Gestão de usuários e permissões (RLS).
 */

export const REPAIR_DB_SQL = `
-- 1. TABELA DE ITENS (ACHADOS)
CREATE TABLE IF NOT EXISTS public.items (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    description text NOT NULL,
    detailed_description text,
    location_found text NOT NULL,
    location_stored text NOT NULL,
    date_found text NOT NULL,
    date_registered text NOT NULL,
    status text NOT NULL DEFAULT 'Disponível',
    returned_to text,
    returned_date text,
    history jsonb DEFAULT '[]'::jsonb
);

-- 2. TABELA DE RELATOS (PERDIDOS)
CREATE TABLE IF NOT EXISTS public.reports (
    id text PRIMARY KEY,
    item_description text NOT NULL,
    person_id text,
    person_name text NOT NULL,
    whatsapp text NOT NULL,
    email text,
    status text NOT NULL DEFAULT 'Aberto',
    created_at text NOT NULL,
    history jsonb DEFAULT '[]'::jsonb
);

-- 3. TABELA DE PESSOAS (CADASTRO)
CREATE TABLE IF NOT EXISTS public.people (
    id text PRIMARY KEY,
    matricula text UNIQUE NOT NULL,
    name text NOT NULL,
    type text NOT NULL
);

-- 4. TABELA DE USUÁRIOS (SISTEMA)
CREATE TABLE IF NOT EXISTS public.users (
    id text PRIMARY KEY,
    matricula text UNIQUE NOT NULL,
    name text NOT NULL,
    password text NOT NULL,
    level text NOT NULL,
    logs text[] DEFAULT '{}'::text[]
);

-- 5. TABELA DE CONFIGURAÇÃO
CREATE TABLE IF NOT EXISTS public.config (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    sector text DEFAULT 'COADES',
    campus text DEFAULT 'NOVA CRUZ'
);

-- 6. TABELA DE ARMÁRIOS
CREATE TABLE IF NOT EXISTS public.lockers (
    number integer PRIMARY KEY,
    status text NOT NULL DEFAULT 'Disponível',
    location text NOT NULL,
    current_loan jsonb,
    maintenance_record jsonb,
    loan_history jsonb DEFAULT '[]'::jsonb,
    maintenance_history jsonb DEFAULT '[]'::jsonb
);

-- 7. HABILITAR SEGURANÇA (RLS)
ALTER TABLE public.items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.people ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.config ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.lockers ENABLE ROW LEVEL SECURITY;

-- 8. POLÍTICAS DE ACESSO (PERMISSIVO PARA ANON)
DROP POLICY IF EXISTS "Acesso Total" ON public.items;
DROP POLICY IF EXISTS "Acesso Total" ON public.reports;
DROP POLICY IF EXISTS "Acesso Total" ON public.people;
DROP POLICY IF EXISTS "Acesso Total" ON public.users;
DROP POLICY IF EXISTS "Acesso Total" ON public.config;
DROP POLICY IF EXISTS "Acesso Total" ON public.lockers;

CREATE POLICY "Acesso Total" ON public.items FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Acesso Total" ON public.reports FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Acesso Total" ON public.people FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Acesso Total" ON public.users FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Acesso Total" ON public.config FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Acesso Total" ON public.lockers FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);

-- 9. FUNÇÕES ADMINISTRATIVAS (RPC)
CREATE OR REPLACE FUNCTION admin_reset_db()
RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  TRUNCATE TABLE public.items RESTART IDENTITY CASCADE;
  TRUNCATE TABLE public.reports CASCADE;
  TRUNCATE TABLE public.people CASCADE;
END;
$$;

CREATE OR REPLACE FUNCTION admin_clear_items_only()
RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  TRUNCATE TABLE public.items RESTART IDENTITY CASCADE;
END;
$$;
`;
