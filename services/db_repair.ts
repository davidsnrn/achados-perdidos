/**
 * SCRIPT DE REPARO E CONFIGURAÇÃO DO BANCO DE DADOS
 * ---------------------------------------------------
 * O erro de "item não aparecendo" ou falha ao salvar geralmente ocorre porque
 * as colunas no banco de dados não existem ou têm nomes diferentes do que o código espera.
 * 
 * Instruções:
 * 1. Copie o código SQL abaixo (entre as crases).
 * 2. Vá ao Painel do Supabase -> SQL Editor.
 * 3. Cole e execute (RUN).
 * 
 * O que este script faz:
 * 1. Garante que as tabelas existam com as colunas EXATAS.
 * 2. Aplica as permissões (RLS).
 * 3. Cria uma FUNÇÃO (RPC) para permitir o Reset de Fábrica real (zerando IDs).
 * 4. Cria uma FUNÇÃO (RPC) para resetar IDs apenas da tabela de Itens.
 */

export const REPAIR_DB_SQL = `
-- 1. CRIAÇÃO DAS TABELAS (Se não existirem)

CREATE TABLE IF NOT EXISTS public.items (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    description text,
    detailed_description text,
    location_found text,
    location_stored text,
    date_found text,
    date_registered text,
    status text,
    returned_to text,
    returned_date text,
    history jsonb DEFAULT '[]'::jsonb
);

CREATE TABLE IF NOT EXISTS public.reports (
    id text PRIMARY KEY,
    item_description text,
    person_id text,
    person_name text,
    whatsapp text,
    email text,
    status text,
    created_at text,
    history jsonb DEFAULT '[]'::jsonb
);

CREATE TABLE IF NOT EXISTS public.people (
    id text PRIMARY KEY,
    matricula text,
    name text,
    type text
);

CREATE TABLE IF NOT EXISTS public.users (
    id text PRIMARY KEY,
    matricula text,
    name text,
    password text,
    level text,
    logs text[]
);

CREATE TABLE IF NOT EXISTS public.config (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    sector text,
    campus text
);

-- GARANTIA DE COMPATIBILIDADE DE ID
ALTER TABLE public.items ALTER COLUMN id SET GENERATED BY DEFAULT;

-- 2. HABILITAR RLS (Segurança)
ALTER TABLE public.items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.people ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.config ENABLE ROW LEVEL SECURITY;

-- 3. DEFINIR POLÍTICAS DE ACESSO (Modo Permissivo)
DROP POLICY IF EXISTS "Permissivo Items" ON public.items;
DROP POLICY IF EXISTS "Permissivo Reports" ON public.reports;
DROP POLICY IF EXISTS "Permissivo People" ON public.people;
DROP POLICY IF EXISTS "Permissivo Users" ON public.users;
DROP POLICY IF EXISTS "Permissivo Config" ON public.config;

CREATE POLICY "Permissivo Items" ON public.items FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Permissivo Reports" ON public.reports FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Permissivo People" ON public.people FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Permissivo Users" ON public.users FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Permissivo Config" ON public.config FOR ALL TO anon, authenticated USING (true) WITH CHECK (true);

-- 4. FUNÇÃO PARA RESETAR IDS (FACTORY RESET TOTAL)
CREATE OR REPLACE FUNCTION admin_reset_db()
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Limpa a tabela de itens e reseta o ID para 1 (TRUNCATE é mais rápido e reseta identity)
  TRUNCATE TABLE public.items RESTART IDENTITY CASCADE;
  
  -- Limpa relatórios e pessoas
  TRUNCATE TABLE public.reports CASCADE;
  TRUNCATE TABLE public.people CASCADE;
END;
$$;

-- 5. FUNÇÃO PARA RESETAR APENAS ITENS (E RESETAR ID)
CREATE OR REPLACE FUNCTION admin_clear_items_only()
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  TRUNCATE TABLE public.items RESTART IDENTITY CASCADE;
END;
$$;
`;
